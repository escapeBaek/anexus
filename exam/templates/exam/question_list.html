{% extends 'base.html' %} {% load exam_filters %} {% block page_content %}

<div class="container mt-5">
  <!-- 상단 타이틀 / 안내문구 -->
  <div class="title-area text-center mb-4">
    <h1 class="display-4 font-weight-bold title-text">
      <span class="gradient-highlight">Questions for {{ exam.title }}</span>
    </h1>
    <p class="lead text-secondary mt-3">
      Manage your time wisely and choose the best answer!
    </p>
  </div>
</div>

<!-- 타이머 섹션 (화면 하단 고정) -->
<div id="timer-section" class="fixed-bottom timer-sticky-area">
  <div class="container py-3">
    <div class="d-flex justify-content-between align-items-center">
      <!-- 타이머 입력 -->
      <div class="timer-input-group">
        <label for="set-timer-input" class="mr-2 font-weight-bold">
          Set Timer (minutes):
        </label>
        <input
          type="number"
          id="set-timer-input"
          class="form-control d-inline-block w-auto"
          min="1"
          value="60"
        />
      </div>
      <!-- Start/End 버튼 -->
      <div>
        <button id="start-exam-btn" class="start-exam-btn">Start</button>
        <button id="end-exam-btn" class="end-exam-btn" style="display: none">
          End Exam
        </button>
      </div>
      <!-- 타이머 표시 -->
      <div id="timer-display" class="timer-display">00:00</div>
    </div>
  </div>
</div>

<!-- 문제 목록 -->
<div class="container mt-3 mb-5">
  <form id="exam-form">
    {% csrf_token %} {% for question in questions %}
    <!-- data-* 속성으로 각 보기 및 correct_option 보관 -->
    <div
      class="card mb-4 shadow-sm question-block"
      data-option1="{{ question.option1 }}"
      data-option2="{{ question.option2 }}"
      data-option3="{{ question.option3 }}"
      data-option4="{{ question.option4 }}"
      {%
      if
      question.option5
      %}data-option5="{{ question.option5 }}"
      {%
      endif
      %}
      data-correct-option="{{ question.correct_option }}"
    >
      <div class="card-body">
        <!-- Category 정보 표시 (있다면) -->
        {% if question.category %}
        <small class="text-muted d-block mb-2" style="opacity: 0.7">
          From Category: {{ question.category.name }}
        </small>
        {% endif %}

        <!-- 문제 텍스트 박스 -->
        <div class="question-text-box mb-3">{{ question.question_text }}</div>

        <!-- 문제 이미지 -->
        {% if question.image %}
        <div class="text-center mb-3">
          <img
            src="{{ question.image.url }}"
            alt="Question Image"
            class="img-fluid rounded shadow-sm"
            style="max-height: 300px; object-fit: contain"
          />
        </div>
        {% endif %}

        <!-- 보기(옵션) -->
        <div class="card-text options">
          <!-- [중요] input/label을 한 줄로 붙여서 공백 문제 해결 -->
          <div class="form-check mb-2">
            <input
              type="radio"
              id="option1_{{ question.id }}"
              name="question_{{ question.id }}"
              value="{{ question.option1 }}"
              class="form-check-input"
            /><label for="option1_{{ question.id }}" class="form-check-label"
              >{{ question.option1 }}</label
            >
          </div>
          <div class="form-check mb-2">
            <input
              type="radio"
              id="option2_{{ question.id }}"
              name="question_{{ question.id }}"
              value="{{ question.option2 }}"
              class="form-check-input"
            /><label for="option2_{{ question.id }}" class="form-check-label"
              >{{ question.option2 }}</label
            >
          </div>
          <div class="form-check mb-2">
            <input
              type="radio"
              id="option3_{{ question.id }}"
              name="question_{{ question.id }}"
              value="{{ question.option3 }}"
              class="form-check-input"
            /><label for="option3_{{ question.id }}" class="form-check-label"
              >{{ question.option3 }}</label
            >
          </div>
          <div class="form-check mb-2">
            <input
              type="radio"
              id="option4_{{ question.id }}"
              name="question_{{ question.id }}"
              value="{{ question.option4 }}"
              class="form-check-input"
            /><label for="option4_{{ question.id }}" class="form-check-label"
              >{{ question.option4 }}</label
            >
          </div>
          {% if question.option5 %}
          <div class="form-check mb-2">
            <input
              type="radio"
              id="option5_{{ question.id }}"
              name="question_{{ question.id }}"
              value="{{ question.option5 }}"
              class="form-check-input"
            /><label for="option5_{{ question.id }}" class="form-check-label"
              >{{ question.option5 }}</label
            >
          </div>
          {% endif %}
        </div>

        <!-- 버튼들 -->
        <div class="btn-group mt-3" role="group">
          <button
            type="button"
            class="btn btn-outline-primary btn-sm"
            onclick="toggleAnswer('answer_{{ question.id }}')"
          >
            Show Answer
          </button>
          <button
            type="button"
            class="btn btn-outline-secondary btn-sm"
            onclick="toggleVisibility('comment_{{ question.id }}')"
          >
            Show Explanation
          </button>
          {% if question.comment_image %}
          <button
            type="button"
            class="btn btn-outline-info btn-sm"
            onclick="toggleVisibility('comment_image_{{ question.id }}')"
          >
            Show Comment Image
          </button>
          {% endif %}
        </div>

        <!-- 정답 영역 -->
        <div id="answer_{{ question.id }}" class="hidden mt-3">
          <span class="badge badge-success">
            Answer: {{ question.correct_option }}
          </span>
        </div>

        <!-- 해설 영역 -->
        <div id="comment_{{ question.id }}" class="hidden mt-2">
          <div class="alert alert-info p-2 mb-0">
            {{ question.comment|safe }}
          </div>
        </div>
        {% if question.comment_image %}
        <div id="comment_image_{{ question.id }}" class="hidden mt-2">
          <img
            src="{{ question.comment_image.url }}"
            alt="Comment Image"
            class="img-fluid"
          />
        </div>
        {% endif %}
      </div>
    </div>
    {% endfor %}
  </form>
</div>

<!-- 모달(설명 표시) -->
<div id="commentModal" class="modal">
  <div class="modal-content">
    <span class="close">&times;</span>
    <div id="modalBodyContent"></div>
  </div>
</div>

<!-- 스크립트 -->
<script>
  let timerInterval;
  let timeRemaining;

  function startTimer(duration) {
    timeRemaining = duration * 60;
    timerInterval = setInterval(function() {
      const minutes = Math.floor(timeRemaining / 60);
      const seconds = timeRemaining % 60;
      document.getElementById('timer-display').textContent =
        (minutes < 10 ? '0' : '') + minutes + ':' + (seconds < 10 ? '0' : '') + seconds;

      if (timeRemaining <= 0) {
        clearInterval(timerInterval);
        endExam();
      }
      timeRemaining--;
    }, 1000);
  }

  function endExam() {
    clearInterval(timerInterval);

    const questionBlocks = document.querySelectorAll('.question-block');
    let numCorrect = 0, numIncorrect = 0, numUnanswered = 0, numNoanswer = 0;
    let detailedResults = [];

    questionBlocks.forEach((block) => {
      // 문제 텍스트
      let questionText = "";
      const questionTextBox = block.querySelector('.question-text-box');
      if (questionTextBox) {
        questionText = questionTextBox.textContent.trim();
      } else {
        const questionNode = block.querySelector('.question-text');
        questionText = questionNode ? questionNode.textContent.trim() : "";
      }

      // data-* 에서 정답 key 및 보기 텍스트 가져오기
      const correctOptionKey = block.dataset.correctOption || "default";
      const option1Text = block.dataset.option1 || "";
      const option2Text = block.dataset.option2 || "";
      const option3Text = block.dataset.option3 || "";
      const option4Text = block.dataset.option4 || "";
      const option5Text = block.dataset.option5 || "";

      // Correct Answer 텍스트 결정 (Fallback 로직)
      let correctAnswerText = "";
      if (correctOptionKey === "option1") correctAnswerText = option1Text;
      else if (correctOptionKey === "option2") correctAnswerText = option2Text;
      else if (correctOptionKey === "option3") correctAnswerText = option3Text;
      else if (correctOptionKey === "option4") correctAnswerText = option4Text;
      else if (correctOptionKey === "option5") correctAnswerText = option5Text;
      else if (correctOptionKey === "default") {
        // noanswer
        correctAnswerText = "";
      } else {
        // fallback: correctOptionKey 자체가 정답
        correctAnswerText = correctOptionKey;
      }

      // 사용자가 선택한 답변
      let selectedAnswerText = "";
      block.querySelectorAll('input[type="radio"]').forEach((opt) => {
        if (opt.checked) {
          selectedAnswerText = opt.value.trim();
        }
      });

      // 결과 분기
      let resultType;
      if (correctOptionKey === "default") {
        numNoanswer++;
        resultType = "noanswer";
      } else if (!selectedAnswerText) {
        numUnanswered++;
        resultType = "unanswered";
      } else if (selectedAnswerText === correctAnswerText) {
        numCorrect++;
        resultType = "correct";
      } else {
        numIncorrect++;
        resultType = "incorrect";
      }

      detailedResults.push({
        question: questionText,
        selected_answer: selectedAnswerText,
        correct_answer: correctAnswerText,
        result: resultType
      });
    });

    const csrfToken = document.querySelector('input[name="csrfmiddlewaretoken"]').value;
    fetch("{% url 'save_exam_results' %}", {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': csrfToken,
      },
      body: JSON.stringify({
        exam_id: {{ exam.id }},
        num_correct: numCorrect,
        num_incorrect: numIncorrect,
        num_unanswered: numUnanswered,
        num_noanswer: numNoanswer,
        detailed_results: detailedResults,
      })
    })
    .then(response => response.json())
    .then(data => {
      if (data.status === 'ok') {
        window.location.href = `{% url 'exam_results' %}?result_id=${data.result_id}`;
      } else {
        alert('An error occurred while saving the results.');
      }
    })
    .catch(error => {
      console.error('Error:', error);
    });
  }

  // 모달 로직
  const modal = document.getElementById('commentModal');
  const modalContent = document.getElementById('modalBodyContent');
  const spanClose = document.querySelector('.close');

  function showModal(content) {
    modalContent.innerHTML = content;
    modal.style.display = 'block';
  }

  spanClose.addEventListener('click', () => {
    modal.style.display = 'none';
  });
  window.addEventListener('click', (event) => {
    if (event.target === modal) {
      modal.style.display = 'none';
    }
  });

  // Toggle answer
  function toggleAnswer(id) {
    const element = document.getElementById(id);
    element.classList.toggle("hidden");
  }

  // Toggle comment
  function toggleVisibility(id) {
    const element = document.getElementById(id);
    if (element) {
      showModal(element.innerHTML);
    }
  }

  // Start & End Exam
  document.getElementById('start-exam-btn').addEventListener('click', function() {
    const duration = parseInt(document.getElementById('set-timer-input').value, 10);
    if (!isNaN(duration) && duration > 0) {
      startTimer(duration);
      document.getElementById('start-exam-btn').style.display = 'none';
      document.getElementById('end-exam-btn').style.display = 'inline-block';
    } else {
      alert('Please enter a valid duration in minutes.');
    }
  });

  document.getElementById('end-exam-btn').addEventListener('click', function() {
    endExam();
  });
</script>

<!-- 스타일 -->
<style>
  .hidden {
    display: none;
  }
  .title-text {
    margin-bottom: 0;
  }
  .gradient-highlight {
    background: linear-gradient(120deg, #84fab0 0%, #8fd3f4 100%);
    color: #fff;
    padding: 0.2em 0.6em;
    border-radius: 0.3em;
  }
  .question-block {
    border-radius: 10px;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }
  .question-block:hover {
    transform: translateY(-3px);
    box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1);
  }
  .question-text-box {
    background-color: #f8f9fa;
    border-left: 4px solid #17a2b8;
    padding: 1rem;
    border-radius: 0 0.25rem 0.25rem 0;
    font-weight: bold;
    line-height: 1.8;
    font-size: 1.125rem;
    color: #333;
  }
  .options .form-check-label {
    font-size: 1rem;
    color: #555;
    cursor: pointer;
    margin-left: 5px; /* 살짝 띄워주기 */
  }
  .btn-outline-primary,
  .btn-outline-secondary,
  .btn-outline-info {
    border-radius: 20px;
    padding: 6px 12px;
    font-size: 0.875rem;
  }
  .badge-success {
    font-size: 0.9rem;
    padding: 6px 10px;
    border-radius: 12px;
  }
  .timer-sticky-area {
    width: 100%;
    border-top: 1px solid #ccc;
    background: linear-gradient(90deg, #f7f7f7, #ececec);
    box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
    border-top-left-radius: 1rem;
    border-top-right-radius: 1rem;
  }
  .timer-input-group {
    display: flex;
    align-items: center;
  }
  .timer-input-group label {
    margin-right: 0.5rem;
    font-weight: bold;
  }
  .timer-display {
    font-size: 1.5rem;
    font-weight: bold;
    color: #333;
    margin-top: 0.5rem;
  }
  .start-exam-btn {
    background: linear-gradient(45deg, #1de9b6, #1dc4e9);
    color: #fff;
    font-weight: bold;
    font-size: 1rem;
    border: none;
    border-radius: 30px;
    padding: 0.5rem 1.5rem;
    box-shadow: 0 3px 8px rgba(29, 233, 182, 0.3);
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    cursor: pointer;
    margin-right: 0.5rem;
  }
  .start-exam-btn:hover {
    transform: scale(1.05);
    box-shadow: 0 6px 15px rgba(29, 233, 182, 0.4);
  }
  .end-exam-btn {
    background: linear-gradient(45deg, #ff5f6d, #ffc371);
    color: #fff;
    font-weight: bold;
    font-size: 1rem;
    border: none;
    border-radius: 30px;
    padding: 0.5rem 1.5rem;
    box-shadow: 0 3px 8px rgba(255, 95, 109, 0.3);
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    cursor: pointer;
  }
  .end-exam-btn:hover {
    transform: scale(1.05);
    box-shadow: 0 6px 15px rgba(255, 95, 109, 0.4);
  }
  .modal {
    display: none;
    position: fixed;
    z-index: 1050;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgba(0, 0, 0, 0.5);
  }
  .modal-content {
    position: relative;
    background-color: #fff;
    margin: 8% auto;
    padding: 30px;
    border: 1px solid #ccc;
    width: 80%;
    max-width: 700px;
    border-radius: 15px;
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
  }
  .close {
    color: #999;
    float: right;
    font-size: 30px;
    font-weight: bold;
    cursor: pointer;
  }
  .close:hover,
  .close:focus {
    color: #000;
    text-decoration: none;
  }
</style>
{% endblock %}
